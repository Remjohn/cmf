<#
    CMF INTELLIGENT PIPELINE - 06_50-12 Monia
    Auto-generated by CMF Automator Generator
    
    FEATURES:
    - Auto-Resume: Skips steps if output files already exist.
    - Isolated Sessions: Runs each step in a fresh Gemini session.
    - Error Handling: Stops immediately if a step fails.
#>

$ErrorActionPreference = "Stop"
$ErrorActionPreference = "Stop"
$projectPath = $PSScriptRoot
$projectId = "06_50-12 Monia"
# Calculate base path: Go up 4 levels from project folder to root
$basePath = (Resolve-Path (Join-Path $PSScriptRoot "../../../..")).Path

function Run-Step {
    param (
        [string]$Name,
        [string[]]$CheckFiles,
        [string]$Command
    )

    $allExist = $true
    foreach ($file in $CheckFiles) {
        $fullCheckPath = Join-Path $projectPath $file
        if (-not (Test-Path $fullCheckPath)) {
            $allExist = $false
            break
        }
    }
    
    if ($allExist) {
        Write-Host "âœ“ [SKIP] ${Name}: All required files exist." -ForegroundColor DarkGray
        return
    }

    Write-Host "Deploying Agent: $Name..." -ForegroundColor Cyan
    
    # Run in headless mode (Fresh Session)
    $prompt = "Project: $projectId`nPath: $projectPath`nExecute: $Command"
    
    gemini --prompt $prompt
    
    if ($LASTEXITCODE -ne 0) {
        Write-Host "ğŸ›‘ ERROR: $Name failed." -ForegroundColor Red
        exit 1
    }
    
    # Verify primary output again (first file in array)
    $primaryPath = Join-Path $projectPath $CheckFiles[0]
    if (-not (Test-Path $primaryPath)) {
        Write-Host "âš ï¸ WARNING: Agent finished but $primaryPath was not created." -ForegroundColor Yellow
    } else {
        Write-Host "âœ“ [DONE] $Name finished." -ForegroundColor Green
    }
}

Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Magenta
Write-Host "â•‘    CMF INTELLIGENT PIPELINE: 06_50-12 Monia     â•‘" -ForegroundColor Magenta
Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Magenta
Write-Host ""

# --- PHASE 1A: SCRIPT ---

Run-Step -Name "Diagnose" `
         -CheckFiles @("strategy_brief.json", "ğŸ˜ 06_50-12 Monia - The Brand Avatar ğŸ˜.md") `
         -Command "/cmf-phase1a-diagnose"

Run-Step -Name "Narrative" `
         -CheckFiles @("06_50-12 Monia_Quote_Manifest.md", "06_50-12 Monia_Quote_Manifest_Enriched.md", "06_50-12 Monia_premise_analysis.json") `
         -Command "/cmf-phase1a-narrative"

Run-Step -Name "Script" `
         -CheckFiles @("final_script.json") `
         -Command "/cmf-phase1a-script"

# --- PHASE 1B: VISUAL ---

Run-Step -Name "Sonic" `
         -CheckFiles @("06_50-12 Monia_sonic_sommelier_brief.md") `
         -Command "/cmf-phase1b-sonic"

Run-Step -Name "Storyboard" `
         -CheckFiles @("06_50-12 Monia_STORYBOARD_PRIMAL.md", "06_50-12 Monia_STORYBOARD_STRUCTURED.md", "06_50-12 Monia_STORYBOARD_VISUAL_POETRY.md") `
         -Command "/cmf-phase1b-storyboard"

Run-Step -Name "Motion" `
         -CheckFiles @("06_50-12 Monia_GMG_PROMPTS.md", "06_50-12 Monia_CAC_PROMPTS.md") `
         -Command "/cmf-phase1b-motion"

Run-Step -Name "E-Roll (Cultural DNA)" `
         -CheckFiles @("06_50-12 Monia_ERoll_Deep_Research_Report.md", "06_50-12 Monia_ERoll_Search_Queries.json", "06_50-12 Monia_EROLL_AUTHORIZED.md") `
         -Command "/cmf-eroll"

Run-Step -Name "Authorize" `
         -CheckFiles @("06_50-12 Monia_PROMPTS_AUTHORIZED.md") `
         -Command "/cmf-phase1b-authorize"

# --- PHASE 2: IMAGE GENERATION ---

Write-Host "Checking Image Assets..." -ForegroundColor Cyan
$imagesDir = Join-Path $projectPath "generated_images"

# We run the image generator if the folder doesn't exist OR if user forces it.
Write-Host "Running OpenRouter Image Generator..." -ForegroundColor Cyan
python "$basePath/tools/cmf_image_generator.py" --project "$projectId" --type all

Write-Host ""
Write-Host "âœ¨ PIPELINE COMPLETE FOR 06_50-12 Monia âœ¨" -ForegroundColor Green
