# **ðŸ“„ architecture.md**

\# architecture.md  
\*\*Project:\*\* Motion Cookbook    
\*\*Version:\*\* v1.0    
\*\*Status:\*\* Canonical Architecture  

\---

\#\# 1\. Architectural Philosophy

Motion Cookbook is a \*\*deterministic explainer animation system\*\* augmented by AI.    
Its architecture is designed around a strict separation of concerns:

\- \*\*AI perceives and prepares\*\*  
\- \*\*Motion Canvas animates and renders\*\*  
\- \*\*Scenes define structure\*\*  
\- \*\*Layers define meaning\*\*

This separation is non-negotiable. Any violation (e.g., AI inventing motion, layouts, or timing) introduces instability and degrades brand consistency.

\---

\#\# 2\. Core Architectural Principle

\> \*\*No motion is ever generated by AI.\*\*    
\> AI outputs \*structure\*, \*semantics\*, and \*assets\*.    
\> Motion logic is authored, versioned, and deterministic.

\---

\#\# 3\. High-Level System Diagram (Conceptual)

User / Agent Input  
â†“  
Context Analyzer (AI)  
â†“  
Narrative Planner (AI)  
â†“  
Scene Selector (Rules \+ AI assist)  
â†“  
Asset Preparation Pipeline  
â”œâ”€ Image Generation (optional)  
â”œâ”€ Layer Extraction  
â”œâ”€ Semantic Labeling  
â†“  
Layer Graph (Canonical Representation)  
â†“  
Scene Resolver  
â†“  
Motion Canvas Renderer  
â†“  
FFmpeg Export  
â†“  
Final Scene Clips (MP4)

\---

\#\# 4\. Major Subsystems

\#\#\# 4.1 Orchestrator

The Orchestrator is the \*\*brain of the system\*\*.    
It coordinates subagents, validates outputs, and ensures all constraints are respected.

Responsibilities:  
\- Decide which scenes to generate (5â€“7).  
\- Ensure no scene repetition unless allowed.  
\- Match available ingredients to scene requirements.  
\- Reject invalid or incomplete configurations.

The Orchestrator never renders video.

\---

\#\#\# 4.2 AI Subsystem (Perception Layer)

AI is used strictly for \*\*interpretation and preparation\*\*, never execution.

Allowed responsibilities:  
\- Interpret user intent and script.  
\- Generate missing still images.  
\- Decompose images into layers (RGBA).  
\- Segment regions (SAM-style).  
\- Assign semantic labels to regions.  
\- Generate short explainer text.

Forbidden responsibilities:  
\- Deciding animation curves.  
\- Deciding timing or pacing.  
\- Generating final video clips.  
\- Modifying scene structure.

\---

\#\#\# 4.3 Layer Graph (Core Artifact)

The \*\*Layer Graph\*\* is the most important data structure in the system.

It represents:  
\- All visual elements as independent RGBA layers.  
\- Their spatial bounds.  
\- Their semantic meaning.  
\- Their allowed transformations.

The Layer Graph is:  
\- Deterministic  
\- Serializable  
\- Cacheable  
\- Reusable across scenes

No rendering happens before a valid Layer Graph exists.

\---

\#\#\# 4.4 Scene Resolver

The Scene Resolver:  
\- Takes a Scene Definition  
\- Injects a Layer Graph  
\- Produces a \*\*Scene Instance Configuration\*\*

It resolves:  
\- Which layers appear in which zones  
\- Which layers are emphasized  
\- Which layers are animated (and how)

\---

\#\#\# 4.5 Motion Canvas Renderer

Motion Canvas is the \*\*only system allowed to animate\*\*.

Responsibilities:  
\- Enforce timing, easing, and motion tokens.  
\- Animate components and layers.  
\- Apply camera motion (zoom, pan).  
\- Produce deterministic frame sequences.

\---

\#\# 5\. Rendering Pipeline

1\. Load Scene Definition  
2\. Load Layer Graph  
3\. Validate compatibility  
4\. Instantiate components  
5\. Apply motion tokens  
6\. Render frames  
7\. Encode MP4

Rendering is stateless and repeatable.

\---

\#\# 6\. Determinism Guarantees

Given:  
\- Identical Scene Definition  
\- Identical Layer Graph  
\- Identical Motion Tokens

The system MUST produce \*\*bitwise-identical output\*\*.

This guarantee enables:  
\- Brand consistency  
\- Debugging  
\- Version control  
\- Scalable automation

\---

\#\# 7\. Deployment Model

\- Stateless workers (e.g., RunPod)  
\- Scene rendering jobs queued  
\- Asset cache shared  
\- No long-lived state in render nodes

\---

\#\# 8\. Failure Handling

\- Invalid AI output â†’ rejected before rendering  
\- Missing layers â†’ scene skipped or substituted  
\- Rendering errors â†’ retry with same inputs  
\- Partial output is never delivered

\---

\#\# 9\. Future Extensions (Non-Breaking)

\- Interactive preview UI  
\- Additional scene variants  
\- Expanded FX layer library  
\- Multi-language text generation

These extensions MUST NOT alter the core contracts defined here.

\---

# **architecture.md \- ADDITIONS NEEDED**

## **Add Section 4: Concrete Data Flow**

\#\# 4\. Concrete Data Flow (File-Level)

\#\#\# Example: Rating Meter Scene Generation

\*\*Step 1: User Input\*\*

data/input/confidence\_rating.json â†“ { "script": "I'm at a 7 right now", "topic": "confidence\_assessment" }

\*\*Step 2: Context Analysis\*\*

agents/context\_analyzer.py processes input â†“ outputs to data/temp/pipeline\_001/analyzed.json â†“ { "topic": "confidence\_assessment", "ratings\_detected": \[{"value": 7, "context": "current"}\], "confidence": 0.94 }

\*\*Step 3: Scene Planning\*\*

agents/scene\_planner.py reads analyzed.json â†“ outputs to data/temp/pipeline\_001/plan.json â†“ { "selected\_scenes": \[{ "scene\_id": "RATING\_METER\_1\_TO\_10", "priority": 10 }\] }

\*\*Step 4: Parameter Filling\*\*

agents/parameter\_filler.py reads plan.json â†“ outputs to data/configs/rating\_meter\_001.json â†“ { "scene\_id": "RATING\_METER\_1\_TO\_10", "parameters": { "rating\_value": 7, "label\_text": "Confidence Level" } }

\*\*Step 5: Rendering\*\*

orchestrator/renderer.py reads config â†“ spawns motion-canvas render \--scene rating\_meter \--config ../data/configs/rating\_meter\_001.json â†“ outputs data/rendered/RATING\_METER\_1\_TO\_10\_001.mp4

\#\# 5\. Error Propagation Flows

\#\#\# Agent Failure Cascade

ContextAnalyzer fails â†“ Logs to: logs/agents/context\_analyzer\_001.error.json â†“ Orchestrator catches exception â†“ Returns: { "status": "failed", "failed\_agent": "ContextAnalyzer", "error": "Invalid JSON in script field", "recovery\_action": "manual\_review" } â†“ NO RENDERING OCCURS

\#\#\# Partial Success Handling

LayerExtractor times out on complex image â†“ Orchestrator checks retry\_policy â†“ After 3 retries: marks layer extraction as "skipped" â†“ Proceeds with fallback: use whole image as single layer â†“ Scene renders with degraded quality â†“ Metadata includes: "warnings": \["layer\_extraction\_fallback"\]

\#\#\# Critical Failure Points  
1\. \*\*Schema Validation\*\* â†’ Reject immediately, no processing  
2\. \*\*Asset Not Found\*\* â†’ Skip scene, log warning  
3\. \*\*Render Timeout\*\* â†’ Kill process, mark failed  
4\. \*\*Disk Full\*\* â†’ Fail entire pipeline, alert admin

\#\# 6\. Validation Gates

\#\#\# Gate 1: Input Validation  
\- Location: \`cli.py\` entry point  
\- Validates: JSON structure, required fields  
\- Failure: Exit code 2, user error message

\#\#\# Gate 2: Agent Output Validation  
\- Location: \`orchestrator/agent\_runner.py\`  
\- Validates: Each agent output against schema  
\- Failure: Retry agent or skip

\#\#\# Gate 3: Scene Config Validation  
\- Location: \`orchestrator/validator.py\`  
\- Validates: Scene parameters completeness  
\- Failure: Reject config, don't render

\#\#\# Gate 4: Render Output Validation  
\- Location: \`orchestrator/renderer.py\`  
\- Validates: File exists, duration correct, not corrupted  
\- Failure: Delete partial file, mark failed

---

## **Add Section 7: Performance Characteristics**

\#\# 7\. Performance Characteristics (Measured)

\#\#\# Typical Pipeline Timings

| Stage | Time (Single Scene) | Parallelizable |  
|-------|---------------------|----------------|  
| Context Analysis | 0.5-1s | No |  
| Scene Planning | 0.2-0.5s | No |  
| Layer Extraction | 2-8s | Yes (per image) |  
| Semantic Labeling | 1-3s | Yes (per layer) |  
| Parameter Filling | 0.1-0.3s | No |  
| Motion Canvas Render | 15-45s | Yes (per scene) |  
| \*\*Total (sequential)\*\* | \*\*20-60s\*\* | \- |  
| \*\*Total (parallel, 4 cores)\*\* | \*\*8-20s\*\* | \- |

\#\#\# Bottlenecks  
1\. \*\*Layer Extraction\*\* \- Dominated by AI model calls  
2\. \*\*Motion Canvas Render\*\* \- CPU-bound (no GPU acceleration)  
3\. \*\*Network I/O\*\* \- If using external AI APIs

\#\#\# Optimization Strategies Already Implemented  
\- Layer graph caching (70% hit rate expected)  
\- Parallel scene rendering  
\- Async agent execution where possible  
